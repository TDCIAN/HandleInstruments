## HandleInstruments
https://www.edwith.org/swiftapp/lecture/26630?isDesc=false


### 핵심 키워드
1. Instruments
  - Disk, Memory, Process 등의 다양한 질문들 중 어떤 프로세스가 리소스를 요청했고, 메모리 누수는 누가 일으키며, CPU 사용은 얼마나 하고 있냐에 대한 것들을 모두 답변하는 것은 어렵다
  - 이전에는 Dtrace를 통해 이와 같은 문제를 해결했다
  - 하지만 처음 프로그래밍을 접하거나 익숙하지 않은 사람들에게는 적절하지 못한 GUI이다.
  - Instruments는 Dtrace 위에서 동작하며 사용하기 쉬운 GUI이다
  - Dtrace는 여러가지 것들을 하나의 윈도우에서 하지 못하지만, Instruments는 가능하다.
  
  
2. Activity Monitor (Blue Color -> CPU와 관련된 게 더 많다)
  - 어디에서 얼마나 CPU가 사용되는지 확인할 수 있다
  - CPU 메모리 디스크를 확인하거나 프로세스와 파일 시스템의 네트워크 사용 통계를 보여준다
  - 시스템 안에서 일어나는 것들의 일반적인 통계를 보여준다
  - 자세하고 뚜렷한 정보를 주지는 않는다. 
  - High level의 정보만 준다(프로세스의 이름이나 CPU 시간이 얼마나 드는지, 스레드의 개수와 메모리 등 기본적인 통계만 알려준다
  - 더 많은 정보를 위해서는 Instruments에서 제공하는 다른 기능들을 확인해야 한다
  
3. Time Profiler (Blue Color -> CPU와 관련된 게 더 많다)
  - CPU가 개발자가 의도한 계산을 하는데 얼마만큼의 시간을 사용하는지 확인할 수 있다
  - 정확히 무엇이 CPU에서 오랜 시간이 걸리게 하는지 찾을 수 있도록 도와준다(그리고 무엇이 잘못됐는지에 대해 알고리즘적으로 깨달음을 준다)
  - 좌측 상단 'CPU Usage' 항목의 그래프는 CPU 사용량과 메인 스레드의 사용량을 보여준다
  - 또 백그라운드에 돌고 있는 Dispatch Worker 스레드와 다른 스레드에 비해 메인 스레드가 얼마나 사용되는지 보여준다
  - Time Profiler가 실행되는 동안 아래에는 호출 트레이스가 보인다(이것은 호출 스택이라고 불리는데, 호출 트리이다)
  - 호출 트리는 앱의 다른 모든 스레드들 안에 어떤 것들이 얽혀 있는지 보여준다
  - 하단부의 Call Tree 탭을 클릭하면 디폴트로 'Separated by Thread' 옵션이 체크되어 있다
  - 스레드에 따라 분리되어 있다
  - 하지만 여기서 추가로 시스템 라이브러리를 숨기는 옵션을 선택할 수 있다
  - 그래서 우리가 클릭한 순간에 시스템 라이브러리가 숨겨진다
  - 방금 보았던 수많은 내용들이 앱 안에 있는 것들로 접혀서 들어간다
  - 그래서 뷰 컨트롤러 안의 것들을 보면 메인 스레드의 메소드가 있다
  - 그리고 그 안에 시간을 오래걸리게 한 메소드가 있다
  - 그 메소드를 더블 클릭하면 Instruments로부터 코드 단계의 자세한 내용을 볼 수 있다(12분 21초 지점)
  - 코드를 확인하면 오른쪽에 어떤 것이 긴 실행시간의 원인인지 퍼센트로 나와 있다(12분 30초 지점)  
  
  
4. Allocations (Orange Color -> RAM과 더 관련이 많다)
  - 메모리가 어떤 식으로 할당되어 동작하는지 확인할 수 있다
  - 프로그램 안에서 다양한 시간에 얼마나 많은 메모리가 할당되는지 살펴볼 수 있다(16분 11초 지점)
  - 예시에서 스위치를 켤 때마다 이미지를 계속 다운로드 받느라 앱에 메모리가 계속 누적되는 상황 (20분 06초 지점)
  
  
5. Leaks (Orange Color -> RAM과 더 관련이 많다)
  - 메모리 누수가 일어나는 곳을 파악하고, 수정 가능하도록 한다. 상호 참조에 의해 메모리 사용량이 계속 늘어난다면 반드시 해결할 수 있어야 한다
  - Instruments에서 Leaks로 주어진 정보를 좀 더 정확히 파악하기 (22분 37초 지점)
  - Cycle & Roots를 사용하면 MallocBlock의 관계를 볼 수 있다
  - 순환 참조 문제를 해결하는 가장 간단한 방법 중 하나는 weak를 사용하는 것이다 (26분 33초 지점)
  - weak를 사용하면 참조 횟수를 증가시키지 않는다
  - 가장 쉽고 근본적으로 해결할 수 있는 방법은 클래스와 구조체, 그리고 참조 타입과 값 타입을 구분해서 사용하는 것이다 (27분 11초 지점)
  - 클래스는 참조 횟수를 증가시키고, 구조체가 할 수 있음에도 클래스를 사용하는 경우가 많다
  - 값 타입을 사용함으로써 메모리 할당 누수 문제를 바로 해결할 수 있다
  - 그러므로 만약 참조 타입이 필요가 없는 상황이라면 값 타입을 사용해야 한다

